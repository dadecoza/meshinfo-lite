{% set this_page = "account" %}
{% extends "layout.html.j2" %}

{% block title %}Account Settings | MeshInfo{% endblock %}

{% block og_title %}Account Settings | {{ config['mesh']['name'] }}{% endblock %}
{% block og_description %}Manage your account settings, change password, and unlink nodes in the {{ config['mesh']['short_name'] }} mesh network.{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .form-control {
      color: #000000 !important;
    }
    .form-control::placeholder {
      color: #6c757d !important;
    }
    input[type="password"] {
      color: #000000 !important;
    }
    .alert {
      margin-top: 1rem;
    }
    .node-item {
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background-color: #f8f9fa;
    }
    .node-item:hover {
      background-color: #e9ecef;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container pt-3">
  <h5>Account Settings</h5>
  
  <div class="row mt-4">
    <!-- Password Change Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Change Password</h6>
        </div>
        <div class="card-body">
          <form id="passwordForm">
            <div class="mb-3">
              <label for="old_password" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="old_password" name="old_password" required>
            </div>
            <div class="mb-3">
              <label for="new_password" class="form-label">New Password</label>
              <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
              <small class="form-text text-muted">Password must be at least 6 characters long.</small>
            </div>
            <div class="mb-3">
              <label for="confirm_password" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6">
            </div>
            <button type="submit" class="btn btn-primary">Change Password</button>
          </form>
          <div id="passwordAlert" class="alert" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Linked Nodes Section -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Linked Nodes</h6>
        </div>
        <div class="card-body">
          {% if nodes %}
            <p class="text-muted">You have {{ nodes|length }} linked node(s).</p>
            {% for id, node in nodes.items()|sort(attribute='1.short_name') %}
              <div class="node-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>
                      <a href="node_{{ id }}.html" style="text-decoration: none; color: inherit;">
                        {{ node.short_name }}
                      </a>
                    </strong>
                    <br>
                    <small class="text-muted">{{ node.long_name }}</small>
                  </div>
                  <button type="button" class="btn btn-sm btn-danger" onclick="confirmUnlinkNode('{{ id }}', '{{ node.short_name }}')">
                    Unlink
                  </button>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">You don't have any linked nodes.</p>
            <a href="{{ url_for('link_node') }}" class="btn btn-info btn-sm">Link a Node</a>
          {% endif %}
          <div id="nodeAlert" class="alert" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Unlink Confirmation Modal -->
<div class="modal fade" id="unlinkModal" tabindex="-1" role="dialog" aria-labelledby="unlinkModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unlinkModalLabel">Confirm Unlink Node</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to unlink node <strong id="unlinkNodeName"></strong> from your account?</p>
        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone. You will need to link the node again using a new OTP if you want to reclaim it.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmUnlinkBtn">Unlink Node</button>
      </div>
    </div>
  </div>
</div>

<script>
let nodeToUnlink = null;

function confirmUnlinkNode(nodeId, nodeName) {
  nodeToUnlink = nodeId;
  document.getElementById('unlinkNodeName').textContent = nodeName;
  $('#unlinkModal').modal('show');
}

document.getElementById('confirmUnlinkBtn').addEventListener('click', function() {
  if (!nodeToUnlink) return;
  
  const nodeIdToUnlink = nodeToUnlink;
  const confirmBtn = document.getElementById('confirmUnlinkBtn');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Unlinking...';
  
  fetch('/api/account/unlink-node', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      node_id: nodeIdToUnlink
    })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => Promise.reject(data));
    }
    return response.json();
  })
  .then(data => {
    $('#unlinkModal').modal('hide');
    const alertDiv = document.getElementById('nodeAlert');
    if (data.error) {
      alertDiv.className = 'alert alert-danger';
      alertDiv.textContent = data.error;
      alertDiv.style.display = 'block';
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Unlink Node';
    } else {
      alertDiv.className = 'alert alert-success';
      alertDiv.textContent = data.success || 'Node unlinked successfully.';
      alertDiv.style.display = 'block';
      
      // Immediately remove the node from the DOM for better UX
      const nodeItems = document.querySelectorAll('.node-item');
      nodeItems.forEach(item => {
        const unlinkBtn = item.querySelector('button[onclick*="' + nodeIdToUnlink + '"]');
        if (unlinkBtn) {
          item.remove();
        }
      });
      
      // Update node count if displayed
      const nodeCountText = document.querySelector('.text-muted');
      if (nodeCountText && nodeCountText.textContent.includes('linked node')) {
        const remainingNodes = document.querySelectorAll('.node-item').length;
        if (remainingNodes === 0) {
          // Reload to show the "no nodes" message
          window.location.reload();
        } else {
          nodeCountText.textContent = `You have ${remainingNodes} linked node(s).`;
        }
      }
      
      // Force reload after a short delay to ensure consistency
      setTimeout(() => {
        window.location.reload(true); // Force reload from server
      }, 500);
    }
  })
  .catch(error => {
    $('#unlinkModal').modal('hide');
    const alertDiv = document.getElementById('nodeAlert');
    alertDiv.className = 'alert alert-danger';
    alertDiv.textContent = error.error || 'An error occurred while unlinking the node.';
    alertDiv.style.display = 'block';
    console.error('Error:', error);
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Unlink Node';
  });
  
  nodeToUnlink = null;
});

document.getElementById('passwordForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const oldPassword = document.getElementById('old_password').value;
  const newPassword = document.getElementById('new_password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  
  if (newPassword !== confirmPassword) {
    const alertDiv = document.getElementById('passwordAlert');
    alertDiv.className = 'alert alert-danger';
    alertDiv.textContent = 'New passwords do not match.';
    alertDiv.style.display = 'block';
    return;
  }
  
  if (newPassword.length < 6) {
    const alertDiv = document.getElementById('passwordAlert');
    alertDiv.className = 'alert alert-danger';
    alertDiv.textContent = 'Password must be at least 6 characters long.';
    alertDiv.style.display = 'block';
    return;
  }
  
  fetch('/api/account/change-password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      old_password: oldPassword,
      new_password: newPassword,
      confirm_password: confirmPassword
    })
  })
  .then(response => response.json())
  .then(data => {
    const alertDiv = document.getElementById('passwordAlert');
    if (data.error) {
      alertDiv.className = 'alert alert-danger';
      alertDiv.textContent = data.error;
    } else {
      alertDiv.className = 'alert alert-success';
      alertDiv.textContent = data.success || 'Password changed successfully.';
      // Clear form
      document.getElementById('passwordForm').reset();
    }
    alertDiv.style.display = 'block';
  })
  .catch(error => {
    const alertDiv = document.getElementById('passwordAlert');
    alertDiv.className = 'alert alert-danger';
    alertDiv.textContent = 'An error occurred while changing the password.';
    alertDiv.style.display = 'block';
    console.error('Error:', error);
  });
});
</script>
{% endblock %}

